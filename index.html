<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Alilazer — Nasiya & To‘lovlar</title>
  <style>
    :root{
      --bg:#0e1116;--panel:#151a22;--border:#232936;--text:#ffffff;--muted:#b6c3d6;
      --accent:#22c55e;--red:#ef4444;--cyan:#06b6d4;
    }
    *{box-sizing:border-box} html,body{margin:0}
    body{background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .topbar{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;padding:12px;border-bottom:1px solid var(--border)}
    h1{font-size:18px;margin:0}.accent{color:#8aff9c}
    .container{padding:12px}
    .cards{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));margin-bottom:12px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
    .card-title{font-size:12px;color:#dbe7ff}.card-value{font-size:22px;color:#fff}
    .card.red{box-shadow:inset 0 0 0 1px rgba(239,68,68,.3)}
    .card.cyan{box-shadow:inset 0 0 0 1px rgba(6,182,212,.3)}
    .card.green{box-shadow:inset 0 0 0 1px rgba(34,197,94,.35)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px}
    .panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
    .panel-actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#000;font-weight:600}
    .btn.ghost{background:#202735;border:1px solid var(--border);color:#fff}
    .btn.warn{background:#3a1f1f;border:1px solid rgba(239,68,68,.5);color:#fff}
    .chip{padding:4px 10px;border-radius:999px;background:#243042;border:1px solid var(--border);color:#fff}
    .input{background:#0f1722;border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:8px}
    .input::placeholder{color:#9fb0c9}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);color:#fff;text-align:left}
    .badge{padding:3px 8px;border-radius:999px;background:#243042;color:#fff;border:1px solid var(--border);font-size:12px}
    .badge.debt{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.4)}
    .badge.pay{background:rgba(6,182,212,.15);border-color:rgba(6,182,212,.4)}
    dialog{border:0}
    .modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;min-width:300px;color:#fff}
    .row{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    .muted{color:var(--muted)}
  </style>

  <!-- Firebase v9 modular (CDN) -->
  <script>
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyA3I7m0ZfpchebCrnxtS0zOZq86eWducKs",
  authDomain: "alilazer-cd582.firebaseapp.com",
  projectId: "alilazer-cd582",
  storageBucket: "alilazer-cd582.firebasestorage.app",
  messagingSenderId: "831212822404",
  appId: "1:831212822404:web:52a0c48d2c1cd1458cc7d1",
  measurementId: "G-S1FNCJ5W99"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      onSnapshot, serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ---- Init
    const app = initializeApp(window.FIREBASE_CONFIG);
    const db  = getFirestore(app);
    const COL = 'Client'; // sizning kolleksiyangiz

    // ---- Helpers
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const money  = n => Number(n||0).toLocaleString('uz-UZ',{style:'currency',currency:'UZS',maximumFractionDigits:0});
    const toNum  = v => (v===undefined||v===null||v==='') ? 0 : Number(v);
    const sanitizePhone = v=>{
      v=(v||'').replace(/\D/g,''); if(!v) return '';
      if(v.startsWith('998')&&v.length===12) return '+'+v;
      if(v.startsWith('0')&&v.length>=10) return '+998'+v.slice(1);
      if(v.length===9) return '+998'+v;
      if(v.length===12) return '+'+v;
      return '+'+v;
    };

    // ---- State
    let clients = [];

    // ---- UI refs
    const tDebt = $('#totalDebt'), tPaid = $('#totalPaid'), tLeft = $('#totalLeft');
    const tbody = $('#clientTbody');

    // ---- Load (realtime)
    const qClients = query(collection(db, COL), orderBy('Ism','asc'));
    onSnapshot(qClients, snap=>{
      clients = snap.docs.map(d=>({id:d.id, ...d.data()}));
      render();
    });

    // ---- Render
    function render(){
      // totals
      let totalDebt=0,totalPaid=0;
      clients.forEach(c=>{ totalDebt += toNum(c.Qarz); totalPaid += toNum(c.Tolov); });
      tDebt.textContent = money(totalDebt);
      tPaid.textContent = money(totalPaid);
      tLeft.textContent = money(Math.max(totalDebt-totalPaid,0));

      // table
      const q = ($('#search').value||'').toLowerCase();
      tbody.innerHTML='';
      clients
        .filter(c=>{
          const n=(c.Ism||'').toLowerCase(), p=(c.Telefon||'').toLowerCase();
          return !q || n.includes(q) || p.includes(q);
        })
        .forEach((c,i)=>{
          const left = Math.max(toNum(c.Qarz)-toNum(c.Tolov),0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${c.Ism||''}</td>
            <td>${c.Telefon||'—'}</td>
            <td>${money(c.Qarz||0)}</td>
            <td>${money(c.Tolov||0)}</td>
            <td><strong>${money(left)}</strong></td>
            <td class="actions"></td>
          `;
          const cell = tr.querySelector('.actions');

          // Ko'rish (qarz/to'lov qo'shish)
          const addDebt = document.createElement('button');
          addDebt.className='chip'; addDebt.textContent='+ Qarz';
          addDebt.onclick=()=>adjust(c.id,'qarz');

          const addPay  = document.createElement('button');
          addPay.className='chip'; addPay.textContent='+ To‘lov';
          addPay.onclick=()=>adjust(c.id,'tolov');

          const edit = document.createElement('button');
          edit.className='chip'; edit.textContent='Tahrirlash';
          edit.onclick=()=>openEdit(c);

          const del = document.createElement('button');
          del.className='chip warn'; del.textContent='O‘chirish';
          del.onclick=()=>removeClient(c.id);

          cell.append(addDebt, addPay, edit, del);
          tbody.appendChild(tr);
        });
    }

    $('#search').addEventListener('input', render);

    // ---- New client modal
    const dlg = $('#clientDlg');
    $('#newClientBtn').addEventListener('click', ()=>{
      $('#f_id').value='';
      $('#f_name').value='';
      $('#f_phone').value='';
      dlg.showModal();
    });

    $('#saveClient').addEventListener('click', async ()=>{
      const id    = $('#f_id').value.trim();
      const Ism   = $('#f_name').value.trim();
      const Telefon = sanitizePhone($('#f_phone').value.trim());
      if(!Ism) return alert('Ism shart');
      try{
        if(id){
          await updateDoc(doc(db,COL,id), { Ism, Telefon });
        }else{
          await addDoc(collection(db,COL), {
            Ism, Telefon, Qarz:0, Tolov:0, Qoldiq:0, createdAt:serverTimestamp()
          });
        }
        dlg.close();
      }catch(e){ alert('Saqlash xatosi: '+e.message); }
    });

    function openEdit(c){
      $('#f_id').value = c.id;
      $('#f_name').value = c.Ism || '';
      $('#f_phone').value = c.Telefon || '';
      dlg.showModal();
    }

    async function removeClient(id){
      if(!confirm('Mijoz o‘chirilsinmi?')) return;
      try{ await deleteDoc(doc(db,COL,id)); }catch(e){ alert('O‘chirish xatosi: '+e.message); }
    }

    // ---- Qarz / To'lov qo'shish (oddiy prompt bilan)
    async function adjust(id, kind){
      const c = clients.find(x=>x.id===id); if(!c) return;
      const raw = prompt(kind==='qarz'?'Qarz miqdori':'To‘lov miqdori','0');
      const amt = Number((raw||'').replace(',', '.'));
      if(!amt || amt<=0) return;

      let Qarz = toNum(c.Qarz), Tolov = toNum(c.Tolov);
      if(kind==='qarz') Qarz += amt; else Tolov += amt;
      const Qoldiq = Math.max(Qarz - Tolov, 0);

      try{
        await updateDoc(doc(db,COL,id), { Qarz, Tolov, Qoldiq });
      }catch(e){ alert('Yangilash xatosi: '+e.message); }
    }

    // ---- Telefon bilan ko‘rish
    $('#viewByPhoneBtn').addEventListener('click', ()=>{
      const p = sanitizePhone($('#phoneLookup').value.trim());
      if(!p) return;
      const c = clients.find(x=>(x.Telefon||'')===p);
      if(!c) return alert('Bu telefon bo‘yicha mijoz topilmadi.');
      alert(`${c.Ism}\nQarz: ${money(c.Qarz)}\nTo‘lov: ${money(c.Tolov)}\nQoldiq: ${money(Math.max(toNum(c.Qarz)-toNum(c.Tolov),0))}`);
    });
  </script>
</head>
<body>
  <header class="topbar">
    <h1>Alilazer — <span class="accent">Nasiya</span> &amp; To‘lovlar</h1>
    <div class="top-actions">
      <input id="search" class="input" placeholder="Qidirish: ism yoki telefon…">
      <input id="phoneLookup" class="input" placeholder="Telefon: +998…" inputmode="tel">
      <button id="viewByPhoneBtn" class="btn ghost">Telefon bilan ko‘rish</button>
      <button id="newClientBtn" class="btn">+ Mijoz qo‘shish</button>
    </div>
  </header>

  <main class="container">
    <section class="cards">
      <div class="card red"><div class="card-title">Jami qarz</div><div class="card-value" id="totalDebt">0</div></div>
      <div class="card cyan"><div class="card-title">Qaytgan to‘lov</div><div class="card-value" id="totalPaid">0</div></div>
      <div class="card green"><div class="card-title">Qoldiq</div><div class="card-value" id="totalLeft">0</div></div>
    </section>

    <section class="panel">
      <div class="panel-header"><h2>Mijozlar</h2></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>#</th><th>Ism</th><th>Telefon</th><th>Qarz</th><th>To‘lov</th><th>Qoldi</th><th>Amal</th></tr>
          </thead>
          <tbody id="clientTbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Mijoz qo'shish / tahrirlash -->
  <dialog id="clientDlg" class="modal">
    <input type="hidden" id="f_id">
    <div class="row">
      <label>Ism
        <input id="f_name" class="input" placeholder="Masalan: Sanjar" required>
      </label>
      <label>Telefon
        <input id="f_phone" class="input" placeholder="+998…" inputmode="tel">
      </label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button onclick="document.getElementById('clientDlg').close()" class="btn ghost">Bekor</button>
      <button id="saveClient" class="btn">Saqlash</button>
    </div>
  </dialog>
</body>
</html>