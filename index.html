<!-- Firebase v9 modular (CDN) â€” TOâ€˜Gâ€˜RILANGAN -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
    onSnapshot, serverTimestamp, query, orderBy
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // ðŸ”§ Firebase config â€” o'zingiznikini qoldiring
  const firebaseConfig = {
    apiKey: "AIzaSyA3I7m0ZfpchebCrnxtS0zOZq86eWducKs",
    authDomain: "alilazer-cd582.firebaseapp.com",
    projectId: "alilazer-cd582",
    // storageBucket: "alilazer-cd582.appspot.com", // kerak bo'lsa
    appId: "1:831212822404:web:52a0c48d2c1cd1458cc7d1",
    measurementId: "G-S1FNCJ5W99"
  };

  // âœ… Init (faqat bir marta)
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const COL = 'Client';

  // ====== Quyidagisi o'zingizdagi KOD AYNAN O'SHA KABI QOLSIN ======
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const money  = n => Number(n||0).toLocaleString('uz-UZ',{style:'currency',currency:'UZS',maximumFractionDigits:0});
  const toNum  = v => (v===undefined||v===null||v==='') ? 0 : Number(v);
  const sanitizePhone = v=>{
    v=(v||'').replace(/\D/g,''); if(!v) return '';
    if(v.startsWith('998')&&v.length===12) return '+'+v;
    if(v.startsWith('0')&&v.length>=10) return '+998'+v.slice(1);
    if(v.length===9) return '+998'+v;
    if(v.length===12) return '+'+v;
    return '+'+v;
  };

  let clients = [];
  const tDebt = $('#totalDebt'), tPaid = $('#totalPaid'), tLeft = $('#totalLeft');
  const tbody = $('#clientTbody');

  const qClients = query(collection(db, COL), orderBy('Ism','asc'));
  onSnapshot(qClients, snap=>{
    clients = snap.docs.map(d=>({id:d.id, ...d.data()}));
    render();
  });

  function render(){
    let totalDebt=0,totalPaid=0;
    clients.forEach(c=>{ totalDebt += toNum(c.Qarz); totalPaid += toNum(c.Tolov); });
    tDebt.textContent = money(totalDebt);
    tPaid.textContent = money(totalPaid);
    tLeft.textContent = money(Math.max(totalDebt-totalPaid,0));

    const q = ($('#search').value||'').toLowerCase();
    tbody.innerHTML='';
    clients
      .filter(c=>{
        const n=(c.Ism||'').toLowerCase(), p=(c.Telefon||'').toLowerCase();
        return !q || n.includes(q) || p.includes(q);
      })
      .forEach((c,i)=>{
        const left = Math.max(toNum(c.Qarz)-toNum(c.Tolov),0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${c.Ism||''}</td>
          <td>${c.Telefon||'â€”'}</td>
          <td>${money(c.Qarz||0)}</td>
          <td>${money(c.Tolov||0)}</td>
          <td><strong>${money(left)}</strong></td>
          <td class="actions"></td>
        `;
        const cell = tr.querySelector('.actions');

        const addDebt = document.createElement('button');
        addDebt.className='chip'; addDebt.textContent='+ Qarz';
        addDebt.onclick=()=>adjust(c.id,'qarz');

        const addPay  = document.createElement('button');
        addPay.className='chip'; addPay.textContent='+ Toâ€˜lov';
        addPay.onclick=()=>adjust(c.id,'tolov');

        const edit = document.createElement('button');
        edit.className='chip'; edit.textContent='Tahrirlash';
        edit.onclick=()=>openEdit(c);

        const del = document.createElement('button');
        del.className='chip warn'; del.textContent='Oâ€˜chirish';
        del.onclick=()=>removeClient(c.id);

        cell.append(addDebt, addPay, edit, del);
        tbody.appendChild(tr);
      });
  }

  $('#search').addEventListener('input', render);

  const dlg = $('#clientDlg');
  $('#newClientBtn').addEventListener('click', ()=>{
    $('#f_id').value='';
    $('#f_name').value='';
    $('#f_phone').value='';
    dlg.showModal();
  });

  $('#saveClient').addEventListener('click', async ()=>{
    const id    = $('#f_id').value.trim();
    const Ism   = $('#f_name').value.trim();
    const Telefon = sanitizePhone($('#f_phone').value.trim());
    if(!Ism) return alert('Ism shart');
    try{
      if(id){
        await updateDoc(doc(db,COL,id), { Ism, Telefon });
      }else{
        await addDoc(collection(db,COL), {
          Ism, Telefon, Qarz:0, Tolov:0, Qoldiq:0, createdAt:serverTimestamp()
        });
      }
      dlg.close();
    }catch(e){ alert('Saqlash xatosi: '+e.message); }
  });

  function openEdit(c){
    $('#f_id').value = c.id;
    $('#f_name').value = c.Ism || '';
    $('#f_phone').value = c.Telefon || '';
    dlg.showModal();
  }

  async function removeClient(id){
    if(!confirm('Mijoz oâ€˜chirilsinmi?')) return;
    try{ await deleteDoc(doc(db,COL,id)); }catch(e){ alert('Oâ€˜chirish xatosi: '+e.message); }
  }

  async function adjust(id, kind){
    const c = clients.find(x=>x.id===id); if(!c) return;
    const raw = prompt(kind==='qarz'?'Qarz miqdori':'Toâ€˜lov miqdori','0');
    const amt = Number((raw||'').replace(',', '.'));
    if(!amt || amt<=0) return;

    let Qarz = toNum(c.Qarz), Tolov = toNum(c.Tolov);
    if(kind==='qarz') Qarz += amt; else Tolov += amt;
    const Qoldiq = Math.max(Qarz - Tolov, 0);

    try{
      await updateDoc(doc(db,COL,id), { Qarz, Tolov, Qoldiq });
    }catch(e){ alert('Yangilash xatosi: '+e.message); }
  }

  $('#viewByPhoneBtn').addEventListener('click', ()=>{
    const p = sanitizePhone($('#phoneLookup').value.trim());
    if(!p) return;
    const c = clients.find(x=>(x.Telefon||'')===p);
    if(!c) return alert('Bu telefon boâ€˜yicha mijoz topilmadi.');
    alert(`${c.Ism}\nQarz: ${money(c.Qarz)}\nToâ€˜lov: ${money(c.Tolov)}\nQoldiq: ${money(Math.max(toNum(c.Qarz)-toNum(c.Tolov),0))}`);
  });
</script>