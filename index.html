<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Alilazer â€” Nasiya & Toâ€˜lovlar</title>
  <style>
    :root{--bg:#0e1116;--panel:#151a22;--border:#232936;--text:#ffffff;--muted:#b6c3d6;--accent:#22c55e;--red:#ef4444;--cyan:#06b6d4}
    *{box-sizing:border-box}html,body{margin:0}
    body{background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .topbar{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;padding:12px;border-bottom:1px solid var(--border)}
    h1{font-size:18px;margin:0}.accent{color:#8aff9c}
    .container{padding:12px}
    .cards{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));margin-bottom:12px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
    .card-title{font-size:12px;color:#dbe7ff}.card-value{font-size:22px;color:#fff}
    .card.red{box-shadow:inset 0 0 0 1px rgba(239,68,68,.3)}
    .card.cyan{box-shadow:inset 0 0 0 1px rgba(6,182,212,.3)}
    .card.green{box-shadow:inset 0 0 0 1px rgba(34,197,94,.35)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px}
    .panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
    .input{background:#0f1722;border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:8px}
    .input::placeholder{color:#9fb0c9}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#000;font-weight:600}
    .btn.ghost{background:#202735;border:1px solid var(--border);color:#fff}
    .btn.warn{background:#3a1f1f;border:1px solid rgba(239,68,68,.5);color:#fff}
    .chip{padding:4px 10px;border-radius:999px;background:#243042;border:1px solid var(--border);color:#fff}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;color:#fff}
    dialog{border:0}
    .modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;min-width:300px;color:#fff}
    .row{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
  </style>

  <!-- Firebase v9 modular (CDN) â€” faqat bitta module skript! -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      onSnapshot, serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ðŸ”§ Firebase config â€” siznikini qoldirdim
    const firebaseConfig = {
      apiKey: "AIzaSyA3I7m0ZfpchebCrnxtS0zOZq86eWducKs",
      authDomain: "alilazer-cd582.firebaseapp.com",
      projectId: "alilazer-cd582",
      appId: "1:831212822404:web:52a0c48d2c1cd1458cc7d1",
      measurementId: "G-S1FNCJ5W99"
      // storageBucket ixtiyoriy: "alilazer-cd582.appspot.com"
    };

    // âœ… Init (bir marta)
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const COL = 'Client';

    // Helpers
    const $  = s => document.querySelector(s);
    const money  = n => Number(n||0).toLocaleString('uz-UZ',{style:'currency',currency:'UZS',maximumFractionDigits:0});
    const toNum  = v => (v===undefined||v===null||v==='') ? 0 : Number(v);
    const sanitizePhone = v=>{
      v=(v||'').replace(/\D/g,''); if(!v) return '';
      if(v.startsWith('998')&&v.length===12) return '+'+v;
      if(v.startsWith('0')&&v.length>=10) return '+998'+v.slice(1);
      if(v.length===9) return '+998'+v;
      if(v.length===12) return '+'+v;
      return '+'+v;
    };

    let clients = [];
    const tDebt = () => document.getElementById('totalDebt');
    const tPaid = () => document.getElementById('totalPaid');
    const tLeft = () => document.getElementById('totalLeft');
    const tbody = () => document.getElementById('clientTbody');

    // Realtime load
    const qClients = query(collection(db, COL), orderBy('Ism','asc'));
    onSnapshot(qClients, snap=>{
      clients = snap.docs.map(d=>({id:d.id, ...d.data()}));
      render();
    }, err => console.error('Firestore error:', err));

    function render(){
      let totalDebt=0,totalPaid=0;
      clients.forEach(c=>{ totalDebt += toNum(c.Qarz); totalPaid += toNum(c.Tolov); });
      tDebt().textContent = money(totalDebt);
      tPaid().textContent = money(totalPaid);
      tLeft().textContent = money(Math.max(totalDebt-totalPaid,0));

      const q = (document.getElementById('search').value||'').toLowerCase();
      tbody().innerHTML='';
      clients
        .filter(c=>{
          const n=(c.Ism||'').toLowerCase(), p=(c.Telefon||'').toLowerCase();
          return !q || n.includes(q) || p.includes(q);
        })
        .forEach((c,i)=>{
          const left = Math.max(toNum(c.Qarz)-toNum(c.Tolov),0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${c.Ism||''}</td>
            <td>${c.Telefon||'â€”'}</td>
            <td>${money(c.Qarz||0)}</td>
            <td>${money(c.Tolov||0)}</td>
            <td><strong>${money(left)}</strong></td>
            <td class="actions"></td>
          `;
          const cell = tr.querySelector('.actions');

          const addDebt = document.createElement('button');
          addDebt.className='chip'; addDebt.textContent='+ Qarz';
          addDebt.onclick=()=>adjust(c.id,'qarz');

          const addPay  = document.createElement('button');
          addPay.className='chip'; addPay.textContent='+ Toâ€˜lov';
          addPay.onclick=()=>adjust(c.id,'tolov');

          const edit = document.createElement('button');
          edit.className='chip'; edit.textContent='Tahrirlash';
          edit.onclick=()=>openEdit(c);

          const del = document.createElement('button');
          del.className='chip warn'; del.textContent='Oâ€˜chirish';
          del.onclick=()=>removeClient(c.id);

          cell.append(addDebt, addPay, edit, del);
          tbody().appendChild(tr);
        });
    }

    document.addEventListener('input', e=>{
      if(e.target && e.target.id==='search') render();
    });

    // Dialog
    function dlg(){ return document.getElementById('clientDlg'); }
    document.getElementById('newClientBtn').addEventListener('click', ()=>{
      document.getElementById('f_id').value='';
      document.getElementById('f_name').value='';
      document.getElementById('f_phone').value='';
      dlg().showModal();
    });

    document.getElementById('saveClient').addEventListener('click', async ()=>{
      const id    = document.getElementById('f_id').value.trim();
      const Ism   = document.getElementById('f_name').value.trim();
      const Telefon = sanitizePhone(document.getElementById('f_phone').value.trim());
      if(!Ism) return alert('Ism shart');
      try{
        if(id){
          await updateDoc(doc(db,COL,id), { Ism, Telefon });
        }else{
          await addDoc(collection(db,COL), { Ism, Telefon, Qarz:0, Tolov:0, Qoldiq:0, createdAt:serverTimestamp() });
        }
        dlg().close();
      }catch(e){ alert('Saqlash xatosi: '+e.message); console.error(e); }
    });

    function openEdit(c){
      document.getElementById('f_id').value = c.id;
      document.getElementById('f_name').value = c.Ism || '';
      document.getElementById('f_phone').value = c.Telefon || '';
      dlg().showModal();
    }

    async function removeClient(id){
      if(!confirm('Mijoz oâ€˜chirilsinmi?')) return;
      try{ await deleteDoc(doc(db,COL,id)); }catch(e){ alert('Oâ€˜chirish xatosi: '+e.message); }
    }

    async function adjust(id, kind){
      const c = clients.find(x=>x.id===id); if(!c) return;
      const raw = prompt(kind==='qarz'?'Qarz miqdori':'Toâ€˜lov miqdori','0');
      const amt = Number((raw||'').replace(',', '.'));
      if(!amt || amt<=0) return;

      let Qarz = toNum(c.Qarz), Tolov = toNum(c.Tolov);
      if(kind==='qarz') Qarz += amt; else Tolov += amt;
      const Qoldiq = Math.max(Qarz - Tolov, 0);

      try{ await updateDoc(doc(db,COL,id), { Qarz, Tolov, Qoldiq }); }
      catch(e){ alert('Yangilash xatosi: '+e.message); }
    }

    // Telefon bilan koâ€˜rish
    document.getElementById('viewByPhoneBtn').addEventListener('click', ()=>{
      const p = sanitizePhone(document.getElementById('phoneLookup').value.trim());
      if(!p) return;
      const c = clients.find(x=>(x.Telefon||'')===p);
      if(!c) return alert('Bu telefon boâ€˜yicha mijoz topilmadi.');
      const msg = `${c.Ism}\nQarz: ${money(c.Qarz)}\nToâ€˜lov: ${money(c.Tolov)}\nQoldiq: ${money(Math.max(toNum(c.Qarz)-toNum(c.Tolov),0))}`;
      alert(msg);
    });
  </script>
</head>
<body>
  <header class="topbar">
    <h1>Alilazer â€” <span class="accent">Nasiya</span> &amp; Toâ€˜lovlar</h1>
    <div class="top-actions">
      <input id="search" class="input" placeholder="Qidirish: ism yoki telefonâ€¦">
      <input id="phoneLookup" class="input" placeholder="Telefon: +998â€¦" inputmode="tel">
      <button id="viewByPhoneBtn" class="btn ghost">Telefon bilan koâ€˜rish</button>
      <button id="newClientBtn" class="btn">+ Mijoz qoâ€˜shish</button>
    </div>
  </header>

  <main class="container">
    <section class="cards">
      <div class="card red"><div class="card-title">Jami qarz</div><div class="card-value" id="totalDebt">0</div></div>
      <div class="card cyan"><div class="card-title">Qaytgan toâ€˜lov</div><div class="card-value" id="totalPaid">0</div></div>
      <div class="card green"><div class="card-title">Qoldiq</div><div class="card-value" id="totalLeft">0</div></div>
    </section>

    <section class="panel">
      <div class="panel-header"><h2>Mijozlar</h2></div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>#</th><th>Ism</th><th>Telefon</th><th>Qarz</th><th>Toâ€˜lov</th><th>Qoldi</th><th>Amal</th></tr></thead>
          <tbody id="clientTbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <dialog id="clientDlg" class="modal">
    <input type="hidden" id="f_id">
    <div class="row">
      <label>Ism <input id="f_name" class="input" placeholder="Masalan: Sanjar" required></label>
      <label>Telefon <input id="f_phone" class="input" placeholder="+998â€¦" inputmode="tel"></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button onclick="document.getElementById('clientDlg').close()" class="btn ghost">Bekor</button>
      <button id="saveClient" class="btn">Saqlash</button>
    </div>
  </dialog>
</body>
</html>